<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>communityDetail</title>
    <!-- 기존 CSS 유지 -->
    <style>
        /* 기존 스타일 그대로 유지 (생략) */
    </style>
</head>
<body>
<!-- header -->
<div th:replace="~{fragments/header}"></div>

<main>
    <div class="style-header">
        <div class="user-info">
            <img th:src="${profileImage != null ? profileImage : '/img/default-profile.jpg'}" alt="사용자 프로필" class="profile-img">
            <div>
                <strong th:text="${username}">사용자:</strong>
                <p th:text="'작성일: ' + ${#temporals.format(post['created_at'].toLocalDateTime(), 'yyyy-MM-dd HH:mm')}" style="margin-top: 4px;">작성일:</p>
            </div>
            <div style="margin-left: auto;">
                <button class="edit-btn" th:if="${currentUser != null and currentUser.userId == post['user_id']}" th:onclick="|location.href='/community/modify/${post['post_id']}'|">
                    <img src="/img/create.png" alt="" style="width: 20px; height: 20px;">
                </button>
                <form th:if="${currentUser != null and currentUser.userId == post['user_id']}" th:action="@{/community/delete/{postId}(postId=${post['post_id']})}" method="post" style="display: inline;">
                    <button type="submit" class="edit-btn">
                        <img src="/img/delete.png" alt="" style="width: 16px; height: 16px;">
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="style-container">
        <div class="style-content">
            <div th:if="${postImages != null and not #lists.isEmpty(postImages)}">
                <div class="slider-container">
                    <div class="slider" id="imageSlider">
                        <div class="slide" th:each="image : ${postImages}">
                            <img th:src="@{${image != null && image.getPostImageUrl() != null ? image.postImageUrl : '/img/default-style.jpg'}}" alt="게시물 이미지" class="style-img">
                        </div>
                    </div>
                    <button class="slider-btn prev-btn" id="prevBtn"><img src="/img/arrow-left.png" alt="Previous"></button>
                    <button class="slider-btn next-btn" id="nextBtn"><img src="/img/arrow-right.png" alt="Next"></button>
                </div>
            </div>
            <div th:unless="${postImages != null and not #lists.isEmpty(postImages)}">
                <img th:src="@{/img/default-style.jpg}" alt="기본 이미지" class="style-img">
            </div>
            <h2 th:text="${post['title']}">스타일 테스트입니다-제목-</h2>
            <p th:text="${post['content']}">스타일 테스트입니다-내용-</p>
            <p th:text="${post['style_category']}" style="color: #acacac; margin-top: 5px; font-size: 13px;">스타일 테스트입니다-스타일 카테고리-</p>
        </div>

        <!-- 모달창 -->
        <div id="commentModal" class="modal">
            <div class="modal-content">
                <span class="close">×</span>
                <h2>댓글</h2>
                <div class="comment-input">
                    <textarea id="commentText" placeholder="댓글을 입력하세요..."></textarea>
                    <button id="submitComment">전송</button>
                </div>
                <div id="commentList" class="comment-list">
                    <!-- 동적으로 댓글 추가 -->
                </div>
            </div>
        </div>

        <div class="community-action">
            <!-- 댓글 -->
            <label class="ui-bookmark3">
                <input type="checkbox" id="commentCheckbox">
                <div class="bookmark">
                    <img src="/img/chat-bubble.png" alt="" style="width: 27px; height: 27px;">
                </div>
            </label>

            <!-- 좋아요 -->
            <label class="ui-bookmark2">
                <input type="checkbox" id="likeCheckbox" th:checked="${isLiked}">
                <div class="bookmark">
                    <svg viewBox="0 0 16 16" style="margin-top:4px" class="bi bi-heart-fill" height="25" width="25" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" fill-rule="evenodd"></path>
                    </svg>
                </div>
            </label>
            <span id="likeCount" th:text="${likeCount}">0</span>

            <!-- 북마크 -->
            <label class="ui-bookmark">
                <input type="checkbox">
                <div class="bookmark">
                    <svg viewBox="0 0 32 32">
                        <g>
                            <path d="M27 4v27a1 1 0 0 1-1.625.781L16 24.281l-9.375 7.5A1 1 0 0 1 5 31V4a4 4 0 0 1 4-4h14a4 4 0 0 1 4 4z"></path>
                        </g>
                    </svg>
                </div>
            </label>

            <!-- 메뉴바 -->
            <label class="menu">
                <input type="button" id="menuButton">
                <div class="bookmark">
                    <img src="/img/more.png" alt="" style="width: 25px; height: 25px;">
                </div>
                <div class="dropdown-menu">
                    <button class="dropdown-item">신고하기</button>
                </div>
            </label>
        </div>

        <div class="product-tags">
            <h3 th:text="'상품태그 ' + ${#lists.size(productTags)} + '개'">상품태그 2개</h3>
            <div class="product-list">
                <div class="product-item" th:each="product : ${productTags}">
                    <img th:src="${product.imageUrl != null ? product.imageUrl : '/img/default-style.jpg'}" alt="상품 이미지" class="product-img">
                    <p th:text="${product.productName}">상품이름:</p>
                </div>
            </div>
        </div>
    </div>

    <section class="other-styles">
        <h3 th:text="'@' + ${username} + '님의 다른 스타일'">@username님의 다른 스타일</h3>
        <div class="style-list">
            <th:block th:each="style : ${otherStyles}">
                <img th:src="@{${style.thumbnailImageUrl != null ? style.thumbnailImageUrl : '/img/default-style.jpg'}}" alt="다른 스타일" class="style-thumbnail">
            </th:block>
        </div>
    </section>
</main>

<!-- footer -->
<div th:replace="~{fragments/footer}"></div>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // 슬라이더 초기화
        const slider = document.getElementById('imageSlider');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const slides = slider.getElementsByClassName('slide');
        let currentIndex = 0;

        function updateSlider() {
            slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        }

        prevBtn.addEventListener('click', function () {
            if (currentIndex > 0) {
                currentIndex--;
                updateSlider();
            }
        });

        nextBtn.addEventListener('click', function () {
            if (currentIndex < slides.length - 1) {
                currentIndex++;
                updateSlider();
            }
        });

        updateSlider();

        // 메뉴 드롭다운
        const menuButton = document.getElementById('menuButton');
        const menuLabel = document.querySelector('.menu');
        menuButton.addEventListener('click', function () {
            menuLabel.classList.toggle('active');
        });

        document.addEventListener('click', function (event) {
            if (!menuLabel.contains(event.target)) {
                menuLabel.classList.remove('active');
            }
        });

        // 좋아요 기능
        const likeCheckbox = document.getElementById('likeCheckbox');
        const likeCountSpan = document.getElementById('likeCount');
        const postId = /*[[${post['post_id']}]]*/ 0; // Thymeleaf로 postId 가져오기, 기본값 0
        let likeCount = parseInt(likeCountSpan.textContent) || 0;

        likeCheckbox.addEventListener('change', function () {
            const isChecked = this.checked;
            const url = isChecked ? `/community/like/${postId}` : `/community/unlike/${postId}`;

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                },
                body: JSON.stringify({ postId: postId })
            })
                .then(response => response.json())
                .then(success => {
                    if (success) {
                        likeCount = isChecked ? likeCount + 1 : likeCount - 1;
                        likeCountSpan.textContent = likeCount;
                    } else {
                        alert('좋아요 처리에 실패했습니다.');
                        this.checked = !isChecked;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.checked = !isChecked;
                });
        });

        // 댓글 모달
        const commentCheckbox = document.getElementById('commentCheckbox');
        const modal = document.getElementById('commentModal');
        const closeModal = document.querySelector('.close');
        const submitCommentBtn = document.getElementById('submitComment');
        const commentText = document.getElementById('commentText');
        const commentList = document.getElementById('commentList');

        const currentUser = {
            userId: /*[[${currentUser != null ? currentUser.userId : 0}]]*/ 0,
            username: /*[[${currentUser != null ? currentUser.username : 'Guest'}]]*/ 'Guest',
            profileImage: /*[[${currentUser != null && currentUser.profileImage != null ? currentUser.profileImage : '/img/default-profile.jpg'}]]*/ '/img/default-profile.jpg'
        };

        commentCheckbox.addEventListener('change', function () {
            modal.style.display = this.checked ? 'flex' : 'none';
        });

        closeModal.addEventListener('click', function () {
            modal.style.display = 'none';
            commentCheckbox.checked = false;
        });

        window.addEventListener('click', function (event) {
            if (event.target === modal) {
                modal.style.display = 'none';
                commentCheckbox.checked = false;
            }
        });

        submitCommentBtn.addEventListener('click', function () {
            const content = commentText.value.trim();
            if (content) {
                addComment(content, null);
                commentText.value = '';
            }
        });

        function addComment(content, parentCommentId) {
            const commentDiv = document.createElement('div');
            commentDiv.classList.add('comment-item');
            commentDiv.dataset.commentId = Date.now();

            commentDiv.innerHTML = `
                <div class="comment-header">
                    <img src="${currentUser.profileImage}" alt="프로필" class="comment-profile-img">
                    <span class="comment-username">${currentUser.username}</span>
                </div>
                <div class="comment-content">${content}</div>
                <span class="reply-btn">답글</span>
                <div class="reply-input">
                    <textarea placeholder="답글을 입력하세요..."></textarea>
                    <button>전송</button>
                </div>
                <div class="replies"></div>
                <label class="ui-bookmark2">
                    <input type="checkbox">
                    <div class="bookmark">
                        <svg viewBox="0 0 16 16" style="margin-top:4px" class="bi bi-heart-fill" height="20" width="20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" fill-rule="evenodd"></path>
                        </svg>
                    </div>
                </label>
            `;

            if (parentCommentId) {
                const parentComment = document.querySelector(`.comment-item[data-comment-id="${parentCommentId}"] .replies`);
                parentComment.appendChild(commentDiv);
            } else {
                commentList.appendChild(commentDiv);
            }

            const replyBtn = commentDiv.querySelector('.reply-btn');
            const replyInput = commentDiv.querySelector('.reply-input');
            replyBtn.addEventListener('click', function () {
                replyInput.style.display = replyInput.style.display === 'block' ? 'none' : 'block';
            });

            const replySubmitBtn = commentDiv.querySelector('.reply-input button');
            const replyText = commentDiv.querySelector('.reply-input textarea');
            replySubmitBtn.addEventListener('click', function () {
                const replyContent = replyText.value.trim();
                if (replyContent) {
                    addComment(replyContent, commentDiv.dataset.commentId);
                    replyText.value = '';
                    replyInput.style.display = 'none';
                }
            });
        }
    });
</script>
</body>
</html>