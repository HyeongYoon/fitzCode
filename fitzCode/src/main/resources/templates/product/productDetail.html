<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.springframework.org/schema/security">
<head>
    <title>Product Page</title>
    <th:block th:replace="~{fragments/header :: header-head}"></th:block>
    <th:block th:replace="~{fragments/footer :: footer-head}"></th:block>
    <link rel="stylesheet" th:href="@{/css/product/productDetail.css}" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container">
    
    <!-- Sticky Bar 폼임 -->
    <div class="sticky-container" id="stickyBar">
        <div class="product_area">
            <!-- 상품 이미지 -->
            <div class="thumbnail">
                <img th:src="${product.imageUrl}" th:alt="${product.productName}">
            </div>
            <!-- 상품 텍스트 정보 -->
            <div class="product_list_info_summary">
                <p class="product_title" th:text="${product.productName}">name</p>
                <p class="product_subtitle" th:text="${product.description}">description</p>
                <p class="product_model" th:text="${product.productId}">number</p>
            </div>
        </div>
        <!-- 버튼 영역 -->
        <div class="btn_area">
            <a href="#" class="btn btn_wish2">장바구니</a>
            <button class="btn_action buy_button">
                <strong>구매</strong>
                <div class="price" th:text="${product.formattedDiscountedPrice}"></div>
            </button>
        </div>
    </div>
    
    
    <div class="product-detail-container">
        <!-- 왼쪽: 상품 이미지 -->
        <div class="product-image-section">
            <div class="product-image">
                <img th:src="${product.imageUrl}" th:alt="${product.productName}">
                
                <th:block th:each="image : ${productImageList}">
                    <img th:src="${image.imageUrl}" th:alt="${product.productName}">
                </th:block>
            
            </div>
            <button class="next-btn">></button>
            <button class="prev-btn"><</button>
        </div>
        
        
        
        <!-- 가운데 구분선 -->
        <div class="divider"></div>
        
        <!-- 오른쪽: 상품 정보 -->
        <div class="product-info-section">
            
            <!-- 상품명 및 상세설명 -->
            <div class="product-name" th:text="${product.productName}">Product Name</div>
            <div class="product-description" th:text="${product.description}">This is a brief description of the product.</div>
            <div class="row">
                <div class="product-salePercent" th:text="${product.formattedDiscountPercentage + '%'}"></div>
                <div class="product-originalPrice" th:text="${product.formattedPrice + ' 원'}"></div>
            </div>
            <div class="product-price" th:text="${product.formattedDiscountedPrice + ' 원'}"></div>
            
            
            
            <!-- 상품 세부 정보 -->
            <dl class="product-details">
                <div class="detail">
                    <div class="text">모델번호</div>
                    <span th:text="${product.productId}">12345</span>
                </div>
                <div class="detail">
                    <div class="text">출시일</div>
<!--                    <span th:text="${#temporals.format(product.createdAt, 'yyyy-MM-dd')}">2025-03-01</span>-->
                </div>
                <div class="detail">
                    <div class="text">발매가</div>
                    <span th:text="${product.formattedPrice}">250,000원</span>
                </div>
                <div class="detail">
                    <div class="text">재고</div>
                    <span th:text="${product.stock}">0</span>
                </div>
            </dl>
            
            
            
            <!--  size selector   -->
            <div class="choose-size">
                <label for="size-options">사이즈 선택:</label>
                <div class="size-option-container">
                    <select id="size-options">
                        <option value="">사이즈 선택</option>
                    </select>
                </div>
            </div>
            
            
            <!-- 구매/판매 버튼 -->
            <div class="button-group">
                <div class="cart-button">
                    
                    <div class="buy-text">장바구니</div>
                </div>
            </div>
            
            <!-- 구매/판매 버튼 -->
            <div class="button-group">
                <a href="/views/product/buy.html" class="buy-button">
                    <div class="buy-text">구매</div>
                    <div class="buy-info">
                        <span class="price" th:text="${product.formattedPrice}" >250,000원</span>
                        <span class="subtext">즉시 구매가</span>
                    </div>
                </a>
            </div>
            

            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>
            <p>hello</p>

        </div>
    </div>
</div>



<p sec:authorize="isAuthenticated()">Current userId: <span th:text="${#authentication.principal.userId}"></span></p>



<div th:replace="~{fragments/footer :: footer}"></div>
</body>



<script>
    // const userId = [[${#authentication.principal != null ? #authentication.principal.userId : -1}]];
    const productId = [[${product.productId}]];

    console.log("User ID:", userId);
    console.log("Product ID:", productId);

    if (userId === "null") {
        console.warn("No user is logged in.");
    }

    function fetchAvailableSizes() {
        console.log("Fetching available sizes...");

        $.ajax({
            url: "/api/product/getProductSizes",
            method: "POST",
            data: { productId: productId },
            dataType: "json",
            success: function (data) {
                console.log("success");
                console.log(data);
                updateSizeOptions(data);
            },
            error: function (xhr, status, error) {
                console.error("Error fetching products:", error);
                isLoading = false;
            }
        });
        
    }

    function updateSizeOptions(sizes) {
        const sizeContainer = document.querySelector(".size-option-container");
        const newSelect = document.createElement("select");
        newSelect.id = "size-options";

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "사이즈 선택";
        newSelect.appendChild(defaultOption);

        sizes.forEach(size => {
            const option = document.createElement("option");
            option.value = size.sizeCode; // Store sizeCode as the value
            option.textContent = `Size: ${size.sizeName} (Stock: ${size.stock})`;
            option.dataset.stock = size.stock; // Store stock as a data attribute
            newSelect.appendChild(option);
        });

        sizeContainer.innerHTML = "";
        sizeContainer.appendChild(newSelect);
    }



    const cartBtn = document.querySelector('.cart-button');

    cartBtn.addEventListener('click', () => {
        
        checkForAddToCart();
    });

    function checkForAddToCart() {
        console.log("add to cart pressed");

        const sizeSelect = document.getElementById("size-options");
        const selectedOption = sizeSelect ? sizeSelect.selectedOptions[0] : null;

        if (!selectedOption || !selectedOption.value) {
            console.log("Please select a size before adding to cart");
            alert("Please select a size before adding to cart");
            return;
        }

        const selectedSize = selectedOption.value;
        const selectedStock = selectedOption.dataset.stock; // Get stock from data attribute
        if (selectedStock <= 0) {
            console.log("No product of this size is available");
            alert("No product of this size is available");
            return;
        }
        addToCart(selectedSize, selectedStock);
        
    }

    function addToCart(sizeCode, selectedStock) {
        console.log("Selected sizeCode:", sizeCode);
        console.log("Stock available:", selectedStock);
        console.log("product number:", productId);
        let sendData = { productId: productId, sizeCode: parseInt(sizeCode) };
        console.log(sendData);

        $.ajax({
            url: "/api/cart/addToCart",
            method: "POST",
            data: { productId: productId, sizeCode: sizeCode },
            success: function (data) {
                console.log("success", data);
                // updateSizeOptions(data);
            },
            error: function (xhr, status, error) {
                if (xhr.status === 401) {
                    console.warn("Unauthorized: Redirecting to login...");
                    window.location.href = "/login";
                } else {
                    console.error("Error adding to cart:", error);
                }
            }
        });

    }


    


    document.addEventListener("DOMContentLoaded", () => {
        // js for the sticky bar
        const stickyBar = document.getElementById("stickyBar");
        window.addEventListener("scroll", () => {
            const scrollY = window.scrollY || window.pageYOffset;
            if (scrollY > 400) {
                stickyBar.style.display = "flex";
            } else {
                stickyBar.style.display = "none";
            }
        });
        fetchAvailableSizes();
        
    });
    


    let index = 0;
    const nextBtn = document.querySelector('.next-btn');
    const prevBtn = document.querySelector('.prev-btn');
    const productImage = document.querySelector('.product-image');
    const totalImages = document.querySelectorAll('.product-image img').length;
    const imageWidth = document.querySelector('.product-image img').offsetWidth;
    
    const updateImagePosition = () => {
        productImage.style.transform = `translateX(-${index * imageWidth}px)`;
    };

    nextBtn.addEventListener('click', () => {
        index = (index + 1) % totalImages;
        updateImagePosition();
    });

    prevBtn.addEventListener('click', () => {
        index = (index - 1 + totalImages) % totalImages;
        updateImagePosition();
    });
    


    




</script>

</html>
