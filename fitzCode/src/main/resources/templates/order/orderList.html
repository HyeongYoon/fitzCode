<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>fitzCode</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
        #searchTracking{
            background-color: white;
            border: #ddd 1px solid;
            padding: 5px 8px;
            border-radius: 15px;
            color: gray;
        }
        #modalContainer {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.5);
        }
        #modalContainer.hidden{
            display: none;
        }
        #modalContent{
            background-color: #ffffff;
            width: 480px;
            height: 450px;
            padding: 15px;
            margin-top: 100px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .modalCloseBtn{
            position: absolute;
            top: 10px;
            cursor: pointer;
            right: 16px;
            background: transparent;
            font-size: 20px;
        }
        #msg{
            color: red;
            margin-top: 25px;
        }
        #trackingData{
            border: 1px solid #ddd;
            border-collapse: collapse;
        }
        #trackingData td,
        #trackingData th{
            border: 1px solid #ddd;
        }
    </style>
    <script>
        $(() => {
            const searchTrackingModal = $("#modalContainer")
            // 배송추적 모달 열기
            $("#searchTracking").on("click", () => {
                searchTrackingModal.removeClass("hidden");
                document.body.style.overflow = 'hidden';
                var t_key = "SUXr60hetBnVCS6h5UjeOw";
                var t_code = "04";
                var t_invoice = document.querySelector('#searchTracking').textContent;
                $.ajax({
                    type : "GET",
                    dataType : "json",
                    url : "https://info.sweettracker.co.kr/api/v1/trackingInfo?t_key="+t_key+"&t_code="+t_code+"&t_invoice="+t_invoice,
                    success:function (data){
                        console.log(data);
                        var header = "";
                        var trackingData = "";
                        var trackingDetails = data.trackingDetails;
                        if(data.status == false){
                            $("#msg").html('<p>'+data.msg+'</p>');
                        } else{
                            header += ('<tr>')
                            header += ('<th>배송시간</th>');
                            header += ('<th>현재위치</th>');
                            header += ('<th>배송상태</th>');
                            header += ('</tr>')

                            $.each(trackingDetails, function (key,value){
                                trackingData += ('<tr>')
                                trackingData += ('<td>'+value.timeString+'</td>');
                                trackingData += ('<td>'+value.where+'</td>');
                                trackingData += ('<td>'+value.kind+'</td>');
                                trackingData += ('</tr>')
                            })
                            $("#deliveryCompany").text("택배사 CJ대한통운")
                            $("#trackingData").html(header + trackingData);
                        }
                    }
                })
            });
            $(".modalCloseBtn").on("click", () => {
                searchTrackingModal.addClass("hidden");
                document.body.style.overflow = "auto";
            });

        })
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

</head>
<body>

<!-- header -->
<div th:replace="~{fragments/header}"></div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<!-- 메인 콘텐츠 -->
<div class="container">
    <table class="table">
        <!-- o.order_id, o.order_status, o.created_at, d.tracking_number -->
        <tr th:if="${not #lists.isEmpty(orderList)}">
            <!--        <tr>-->
            <th>주문 번호</th>
            <th>운송장 번호</th>
            <th>주문 날짜</th>
            <th>주문 상태</th>
            <th></th>
        </tr>
        <tr th:each="list : ${orderList}">
            <td th:text="${list['order_id']}"></td>
            <td><div th:text="${list['tracking_number']}" /></td>
            <td th:text="${#dates.format(list['created_at'],'yyyy/MM/dd')}"/>
            <td th:text="${list['order_status']}"/>
            <td><button id="searchTracking">배송조회</button></td>
        </tr>
    </table>
</div>

<!-- 택배 추적 모달 -->
<div class="hidden" id="modalContainer">
    <div id="modalContent">
        <div class="modalCloseBtn">&times;</div>
        <div>
            <div id="msg"></div>
            <span id="deliveryCompany"></span>
        </div>
        <table class="table" id="trackingData">
        </table>
    </div>
</div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<!-- footer -->
<div th:replace="~{fragments/footer}"></div>

</body>
</html>
