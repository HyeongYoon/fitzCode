<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>상품 등록/수정</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
        }
        input[type="file"] {
            padding: 5px;
        }
        img {
            max-width: 200px;
            margin-top: 10px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        button {
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .remove-size, .remove-image {
            background-color: #ff4444;
        }
        .remove-size:hover, .remove-image:hover {
            background-color: #cc0000;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>상품 등록/수정</h2>
    <form th:action="@{/admin/products}" th:method="post" enctype="multipart/form-data" id="productForm">
        <input type="hidden" th:name="productId" th:value="${product.productId}">
        <div class="form-group">
            <label for="productName">상품 이름</label>
            <input type="text" id="productName" th:name="productName" th:value="${product.productName}" required>
        </div>
        <div class="form-group">
            <label for="description">상품 설명</label>
            <textarea id="description" th:name="description" th:text="${product.description}"></textarea>
        </div>
        <div class="form-group">
            <label for="brand">브랜드</label>
            <input type="text" id="brand" th:name="brand" th:value="${product.brand}">
        </div>
        <div class="form-group">
            <label for="price">가격</label>
            <input type="number" id="price" th:name="price" th:value="${product.price}" required>
        </div>
        <div class="form-group">
            <label for="categoryId">카테고리</label>
            <select id="categoryId" th:name="categoryId" required>
                <option value="">카테고리 선택</option>
                <th:block th:each="category : ${categories}">
                    <option th:value="${category.categoryId}" th:text="${category.name}" th:selected="${product.categoryId == category.categoryId}"></option>
                </th:block>
            </select>
        </div>
        <div class="form-group">
            <label for="stock">총 재고</label>
            <input type="number" id="stock" th:name="stock" th:value="${product.stock}" required>
        </div>
        <div class="form-group">
            <label for="status">상태</label>
            <select id="status" th:name="status" required>
                <option value="판매 중" th:selected="${product.status.description == '판매 중'}">판매 중</option>
                <option value="품절" th:selected="${product.status.description == '품절'}">품절</option>
                <option value="비활성" th:selected="${product.status.description == '비활성'}">비활성</option>
            </select>
        </div>
        <div class="form-group">
            <label for="imageUrl">메인 이미지</label>
            <input type="file" id="imageUrl" th:name="imageUrl" accept="image/*">
            <img th:if="${product.imageUrl}" th:src="${product.imageUrl}" style="max-width: 200px;">
        </div>
        <div class="form-group">
            <label>추가 이미지</label>
            <input type="file" th:name="additionalImages" accept="image/*" multiple>
            <div th:each="image : ${product.additionalImages}">
                <img th:src="${image}" style="max-width: 200px;">
                <button type="button" class="remove-image" th:data-url="${image}">삭제</button>
            </div>
        </div>
        <div class="form-group">
            <label>사이즈별 재고</label>
            <th:block th:each="size, sizeStat : ${product.productSizes}">
                <div class="input-group">
                    <input type="hidden" th:name="'productSizes[' + ${sizeStat.index} + '].productSizeId'" th:value="${size.productSizeId}">
                    <select th:name="'productSizes[' + ${sizeStat.index} + '].sizeCode'">
                        <option value="1" th:selected="${size.sizeCode == 1}">220</option>
                        <option value="2" th:selected="${size.sizeCode == 2}">225</option>
                        <option value="3" th:selected="${size.sizeCode == 3}">230</option>
                        <option value="10" th:selected="${size.sizeCode == 10}">S</option>
                        <option value="11" th:selected="${size.sizeCode == 11}">M</option>
                        <option value="12" th:selected="${size.sizeCode == 12}">L</option>
                    </select>
                    <input type="number" th:name="'productSizes[' + ${sizeStat.index} + '].stock'" th:value="${size.stock}" required>
                    <button type="button" class="remove-size">삭제</button>
                </div>
            </th:block>
            <button type="button" id="addSize">사이즈 추가</button>
        </div>
        <button type="submit">저장</button>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        $('#addSize').click(function() {
            var sizeHtml = '<div class="input-group">' +
                '<select name="productSizes[${product.productSizes.length}].sizeCode">' +
                '<option value="1">220</option>' +
                '<option value="2">225</option>' +
                '<option value="3">230</option>' +
                '<option value="10">S</option>' +
                '<option value="11">M</option>' +
                '<option value="12">L</option>' +
                '</select>' +
                '<input type="number" name="productSizes[${product.productSizes.length}].stock" required>' +
                '<button type="button" class="remove-size">삭제</button>' +
                '</div>';
            $('.form-group:last').before(sizeHtml);
        });

        $(document).on('click', '.remove-size', function() {
            $(this).closest('.input-group').remove();
        });

        $(document).on('click', '.remove-image', function() {
            var imageUrl = $(this).data('url');
            $.ajax({
                url: '/admin/products/edit?id=' + ${product.productId} + '/image',
                type: 'DELETE',
                data: { imageUrl: imageUrl },
            success: function() {
                $(this).closest('div').remove();
            }.bind(this),
                error: function(xhr, status, error) {
                console.error('이미지 삭제 실패:', error);
            }
        });
        });

        $('#productForm').submit(function(e) {
            var formData = new FormData(this);
            var status = $('#status').val();
            formData.append('status', status);
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    window.location.href = '/admin/products/list';
                },
                error: function(xhr, status, error) {
                    console.error('상품 저장 실패:', error);
                }
            });
            e.preventDefault();
        });
    });
</script>
</body>
</html>