<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.fitzcode.admin.mapper.DashboardMapper">

    <!-- 상태별 문의 개수 조회 -->
    <select id="countByStatus" parameterType="int" resultType="int">
        SELECT COUNT(*) FROM INQUIRY
        WHERE status = #{status}
    </select>

    <!-- 1주일간 신규 가입자 수 조회 (날짜 정보 포함) -->
    <select id="getWeeklyNewUsersWithDates" resultType="java.util.HashMap">
        SELECT DATE(created_at) AS signup_date, COUNT(*) AS count
        FROM USER
        WHERE DATE(created_at) BETWEEN DATE_SUB(CURDATE(), INTERVAL 6 DAY) AND CURDATE()
        GROUP BY DATE(created_at)
        ORDER BY DATE(created_at) ASC
    </select>

    <!-- 월별 총 매출 조회 (날짜와 금액 정보 포함) -->
    <select id="getMonthlyTotalSales" resultType="java.util.HashMap">
        SELECT DATE_FORMAT(created_at, '%Y-%m') AS sale_month, SUM(total_price) AS total_sales
        FROM `ORDERS`
        WHERE DATE(created_at) BETWEEN DATE_SUB(CURDATE(), INTERVAL 11 MONTH) AND CURDATE()
        GROUP BY DATE_FORMAT(created_at, '%Y-%m')
        ORDER BY sale_month ASC
    </select>

    <!-- 오늘의 총 주문 수 -->
    <select id="getTodayOrdersCount" resultType="int">
        SELECT COUNT(*) FROM `ORDERS` WHERE DATE(created_at) = CURDATE()
    </select>

    <!-- 오늘의 총 매출 -->
    <select id="getTodayTotalSales" resultType="java.lang.Integer">
        SELECT IFNULL(SUM(total_price), 0) FROM `ORDERS` WHERE DATE(created_at) = CURDATE()
    </select>

    <!-- 현재 접속자 수 (임시 기본값, 나중에 WebSocket으로 수정) -->
    <select id="getCurrentVisitors" resultType="int">
        SELECT 0
    </select>

    <!-- 최근 24시간 동안의 취소/반품 요청 수 -->
    <select id="getCancelReturnsCount" resultType="int">
        SELECT COUNT(*) FROM `ORDERS`
        WHERE order_status IN (4)  <!-- CANCELLED = 4 -->
        AND DATE(updated_at) >= DATE_SUB(CURDATE(), INTERVAL 1 DAY)
    </select>

    <!-- 등급별 회원 수 조회 -->
    <select id="getMemberTierCounts" resultType="java.util.HashMap">
        SELECT tier_level AS level, COUNT(*) AS count
        FROM `USER_TIER`
        GROUP BY tier_level
        ORDER BY tier_level ASC
    </select>
</mapper>