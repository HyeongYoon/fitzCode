<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.fitzcode.admin.mapper.AdminRefundMapper">

    <resultMap id="RefundResultMap" type="kr.co.fitzcode.common.dto.RefundDTO">
        <id property="refundId" column="refund_id"/>
        <result property="orderId" column="order_id"/>
        <result property="orderDetailId" column="order_detail_id"/>
        <result property="paymentId" column="payment_id"/>
        <result property="refundReason" column="refund_reason"/>
        <result property="refundStatus" column="refund_status"/>
        <result property="refundAmount" column="refund_amount"/>
        <result property="remainingRefundAmount" column="remaining_refund_amount"/>
        <result property="refundMethod" column="refund_method"/>
        <result property="requestedAt" column="requested_at"/>
        <result property="processedAt" column="processed_at"/>
        <result property="completedAt" column="completed_at"/>
        <result property="userName" column="user_name"/>
        <result property="transactionId" column="transaction_id"/>
        <result property="paymentAmount" column="payment_amount"/>
        <result property="userId" column="user_id"/>
    </resultMap>

    <!-- 환불 목록 조회 -->
    <select id="getRefundList" resultMap="RefundResultMap">
        SELECT r.refund_id, r.order_id, r.order_detail_id, r.payment_id, r.refund_reason, r.refund_status,
        r.refund_amount, r.remaining_refund_amount, r.refund_method, r.requested_at, r.processed_at, r.completed_at,
        u.user_name, u.user_id, p.transaction_id, p.amount as payment_amount
        FROM REFUND r
        LEFT JOIN ORDERS o ON r.order_id = o.order_id
        LEFT JOIN USER u ON o.user_id = u.user_id
        LEFT JOIN PAYMENT p ON r.payment_id = p.payment_id
        <where>
            <if test="status != null">
                AND r.refund_status = #{status}
            </if>
            <if test="orderId != null">
                AND o.order_id = #{orderId}
            </if>
        </where>
        ORDER BY r.requested_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 환불 상세 조회 -->
    <select id="getRefundDetail" parameterType="long" resultMap="RefundResultMap">
        SELECT r.refund_id, r.order_id, r.order_detail_id, r.payment_id, r.refund_reason, r.refund_status,
        r.refund_amount, r.remaining_refund_amount, r.refund_method, r.requested_at, r.processed_at, r.completed_at,
        u.user_name, u.user_id, p.transaction_id, p.amount as payment_amount
        FROM REFUND r
        LEFT JOIN ORDERS o ON r.order_id = o.order_id
        LEFT JOIN USER u ON o.user_id = u.user_id
        LEFT JOIN PAYMENT p ON r.payment_id = p.payment_id
        WHERE r.refund_id = #{refundId}
    </select>

    <!-- 환불 상태 업데이트 -->
    <update id="updateRefundStatus" parameterType="map">
        UPDATE REFUND
        SET refund_status = #{status},
        processed_at = CASE WHEN #{status} = 2 THEN CURRENT_TIMESTAMP ELSE processed_at END,
        completed_at = CASE WHEN #{status} = 3 THEN CURRENT_TIMESTAMP ELSE completed_at END
        WHERE refund_id = #{refundId}
    </update>

    <!-- 남은 환불 가능 금액 업데이트 -->
    <update id="updateRemainingRefundAmount" parameterType="map">
        UPDATE REFUND
        SET remaining_refund_amount = #{remainingAmount}
        WHERE refund_id = #{refundId}
    </update>

    <!-- 환불 금액 업데이트 -->
    <update id="updateRefundAmount" parameterType="map">
        UPDATE REFUND
        SET refund_amount = #{refundAmount}
        WHERE refund_id = #{refundId}
    </update>

    <!-- ORDER_DETAIL 환불 상태 업데이트 -->
    <update id="updateOrderDetailRefundStatus" parameterType="map">
        UPDATE ORDER_DETAIL
        SET refund_status = #{status}
        WHERE order_detail_id = #{orderDetailId}
    </update>

    <!-- SALES_TRANSACTION_LOG에 환불 기록 인서트 -->
    <insert id="insertSalesTransactionLog" parameterType="map">
        INSERT INTO SALES_TRANSACTION_LOG (order_id, order_detail_id, product_id, user_id, transaction_date, quantity, amount, transaction_type)
        SELECT #{orderId}, #{orderDetailId}, od.product_id, o.user_id, CURRENT_TIMESTAMP, od.quantity, #{amount}, #{transactionType}
        FROM ORDER_DETAIL od
        JOIN ORDERS o ON od.order_id = o.order_id
        WHERE od.order_detail_id = #{orderDetailId}
    </insert>

    <!-- 알림 -->
    <insert id="insertNotification" parameterType="map">
        INSERT INTO NOTIFICATION (user_id, type, message, related_id)
        VALUES (#{userId}, #{type}, #{message}, #{relatedId})
    </insert>

    <!-- 총 환불 건수 조회 -->
    <select id="getRefundCount" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM REFUND r
        LEFT JOIN ORDERS o ON r.order_id = o.order_id
        <where>
            <if test="status != null">
                AND r.refund_status = #{status}
            </if>
            <if test="orderId != null">
                AND o.order_id = #{orderId}
            </if>
        </where>
    </select>
</mapper>