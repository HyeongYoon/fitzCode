<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.fitzcode.admin.mapper.SearchRankingMapper">

    <!-- 상위 10개 검색어 조회 (search_ranking_history에 의존하지 않음) -->
    <select id="getSearchRanking" resultType="kr.co.fitzcode.common.dto.SearchRankingDTO">
        SELECT search_keyword AS keyword, COUNT(*) AS todaySearchCount
        FROM search_log
        WHERE DATE(search_time) = CURDATE()
        GROUP BY search_keyword
        ORDER BY todaySearchCount DESC
        LIMIT 10
    </select>

    <!-- 오늘 검색된 고유 키워드 수 조회 -->
    <select id="getTotalSearchRankingCount" resultType="int">
        SELECT COUNT(DISTINCT search_keyword)
        FROM search_log
        WHERE DATE(search_time) = CURDATE()
    </select>

    <!-- 이전 날짜의 순위 조회 (search_ranking_history에서) -->
    <select id="getPreviousRanking" parameterType="map" resultType="int">
        SELECT ranking
        FROM search_ranking_history
        WHERE search_keyword = #{keyword}
        AND date = #{date}
        LIMIT 1
    </select>

    <!-- search_ranking_history에 삽입/갱신 (배치 작업에서 사용 가능) -->
    <insert id="insertOrUpdateSearchRanking">
        INSERT INTO search_ranking_history (search_keyword, ranking, date)
        VALUES (#{keyword}, #{ranking}, #{date})
        ON DUPLICATE KEY UPDATE ranking = #{ranking}
    </insert>

</mapper>