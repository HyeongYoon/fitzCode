<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.fitzcode.admin.mapper.AdminOrderMapper">

    <!-- 주문 목록 조회 -->
    <select id="getOrderList" resultType="kr.co.fitzcode.common.dto.AdminOrderDTO">
        SELECT o.order_id, o.order_status, o.created_at,
        CONCAT(
        (SELECT p.product_name
        FROM ORDER_DETAIL od
        JOIN PRODUCT p ON od.product_id = p.product_id
        WHERE od.order_id = o.order_id
        LIMIT 1),
        CASE
        WHEN (SELECT COUNT(*) FROM ORDER_DETAIL od2 WHERE od2.order_id = o.order_id) > 1
        THEN CONCAT(' 외 ', (SELECT COUNT(*) - 1 FROM ORDER_DETAIL od2 WHERE od2.order_id = o.order_id), '개')
        ELSE ''
        END
        ) AS productName
        FROM ORDERS o
        INNER JOIN ORDER_DETAIL od ON o.order_id = od.order_id
        <where>
            <if test="status != null">
                AND o.order_status = #{status}
            </if>
        </where>
        GROUP BY o.order_id, o.order_status, o.created_at
        <choose>
            <when test="sortBy == 'status'">
                ORDER BY o.order_status DESC
            </when>
            <otherwise>
                ORDER BY o.created_at DESC
            </otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 주문 수 조회 -->
    <select id="getTotalOrderCount" parameterType="java.lang.Integer" resultType="int">
        SELECT COUNT(DISTINCT o.order_id)
        FROM ORDERS o
        LEFT JOIN ORDER_DETAIL od ON o.order_id = od.order_id
        <where>
            <if test="status != null">
                AND o.order_status = #{status}
            </if>
        </where>
    </select>

</mapper>